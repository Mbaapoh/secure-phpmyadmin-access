# Template for HTTP-ONLY sites.
# Generated by Ansible for {{ ansible_fqdn }}
################################################################################
{% if item.key == "default" %}
server {
    listen        {{ item.value.listen | default(80) }} default_server;
    listen   [::]:{{ item.value.listen | default(80) }} default_server;
    server_name _;
    access_log /var/log/nginx/{{ item.key | replace('.', '_') }}.http.access.log timed_combined;
    error_log /var/log/nginx/{{ item.key | replace('.', '_') }}.http.error.log error;
    return        444;
}

{% elif not (item.value.ssl | default(false)) %} 
upstream {{ item.key | replace('.', '_') }}_backend  {
{% for upstream_server in item.value.upstreams %}
    server {{ upstream_server.backend_address }}:{{ upstream_server.backend_port }} weight={{ upstream_server.weight | default(1) }}{% if 'params' in upstream_server and upstream_server.params %} {{ upstream_server.params | trim }}{% endif %};
{% endfor %}
}

server {
   listen         {{ item.value.listen | default(80) }};
   listen    [::]:{{ item.value.listen | default(80) }};
   server_name    {{ item.value.domains | join(' ') }};

   access_log /var/log/nginx/{{ item.key | replace('.', '_') }}.http.access.log timed_combined;
   error_log /var/log/nginx/{{ item.key | replace('.', '_') }}.http.error.log warn;

   location /.well-known/acme-challenge/ {
      root /var/www/{{ item.key }};
   }

   location / {
    {% if item.value.redirect_url is defined %}
    return 301 {{ item.value.redirect_url }};
    {% else %}
    {% if item.value.whitelist is defined %}
    {% for iprange in item.value.whitelist %}
     # Whitelisted IPs
    allow {{ iprange }};
    {% endfor %}
    deny all;
    {% endif %}

    
    {% if item.value.nginx_cors_enabled | default(false) | bool and item.value.cors_accept_origins is defined and item.value.cors_accept_origins %}
    # CORS Headers
    set $cors_allowed_origin "";
    {% for origin_host_pattern in item.value.cors_accept_origins %}
    if ($http_origin = "https://{{ origin_host_pattern }}") {
        set $cors_allowed_origin $http_origin;
    }
    if ($http_origin = "http://{{ origin_host_pattern }}") {
        set $cors_allowed_origin $http_origin;
    }
    {% endfor %}

   # These headers are added if the main Jinja 'if' for CORS is true.
    add_header 'Access-Control-Allow-Origin' "$cors_allowed_origin" always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With, Accept, Origin' always;

    
    if ($request_method = 'OPTIONS') {
        # --- Handle CORS preflight (OPTIONS) requests ---
        add_header 'Access-Control-Allow-Origin' "$cors_allowed_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With, Accept, Origin' always;
        add_header 'Access-Control-Max-Age' 1728000 always;
        add_header 'Content-Length' 0 always;
        add_header 'Content-Type' 'text/plain; charset=utf-8' always;
        return 204;
    }

    # Hide backend CORS headers to avoid conflicts
    proxy_hide_header "Access-Control-Allow-Origin";
    proxy_hide_header "Access-Control-Allow-Credentials";
    proxy_hide_header "Access-Control-Allow-Methods";
    proxy_hide_header "Access-Control-Allow-Headers";
    proxy_hide_header "Access-Control-Expose-Headers";
    proxy_hide_header "Access-Control-Max-Age";
    {% endif %}

    include /etc/nginx/{{ nginx_proxy_params_file | default('snippets/hardened_proxy.conf') }};

    {% if item.value.proxy_ssl_verify is defined %}
    proxy_ssl_verify {{ 'on' if item.value.proxy_ssl_verify | bool else 'off' }};
    {% endif %}

  
    fastcgi_read_timeout {{ item.value.fastcgi_read_timeout | default(nginx_fastcgi_read_timeout | default(300)) }}s;

    proxy_pass {{ item.value.backend_protocol | default('http') }}://{{ item.key | replace('.', '_') }}_backend;

    {% if item.value.auth is defined %}
    auth_basic "Restricted Content";
    auth_basic_user_file "/etc/nginx/{{ item.key | replace('.', '_') }}_htpasswd";
    {% endif %}

    {{ item.value.custom_https_location_directives | default('') }}
    {% endif %}
}

   {{ item.value.custom_http_server_directives | default('') }}
}
{% endif %}