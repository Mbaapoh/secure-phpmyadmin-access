user www-data;
worker_processes {{ nginx_worker_processes | default(2) }};
pid /run/nginx.pid;

# load_module modules/ngx_http_headers_more_filter_module.so; # Only if 'more_clear_headers' isn't recognized
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections {{ nginx_worker_connections | default(2048) }};
    multi_accept on;
    use epoll; # Ensure your kernel supports epoll (standard on modern Linux)
}

worker_rlimit_nofile {{ nginx_worker_rlimit_nofile | default(32768) }};

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout {{ nginx_keepalive_timeout | default(65) }};
    keepalive_requests {{ nginx_keepalive_requests | default(1000) }};
    types_hash_max_size {{ nginx_types_hash_max_size | default(2048) }};
    server_names_hash_bucket_size {{ nginx_server_names_hash_bucket_size | default(128) }}; # Consider 64 if you have few server names, or 128 if many.
    # server_names_hash_max_size {{ nginx_server_names_hash_max_size | default(512) }};

    # --- Core Security Headers (Moved to hardened_proxy.conf to avoid duplication/inheritance issues) ---

    # --- Server Identity Obfuscation ---
    server_tokens {{ nginx_server_tokens | default('off') }}; # Hides Nginx version
    server_name_in_redirect {{ nginx_server_name_in_redirect | default('off') }};
    more_clear_headers Server; # Remove "Server: nginx" header entirely (requires ngx_http_headers_more_filter_module from nginx-extras)

    # --- Additional Recommended Security Headers (Safer Global Options) ---
    # Permissions Policy: Restrict browser features to enhance security and privacy.
    # Disable most by default globally. Specific sites can override if needed.

    # Content Security Policy (CSP) - Minimal Safe Version:
    # add_header Content-Security-Policy "frame-ancestors 'self'; object-src 'none'; base-uri 'self';" always;

    # Cross-Origin-Opener-Policy (COOP): Helps isolate your site.

    # Cross-Origin-Resource-Policy (CORP): Prevents others from embedding your resources.
    # add_header Cross-Origin-Resource-Policy "same-origin" always;

    # X-Permitted-Cross-Domain-Policies: For legacy Adobe products (Flash/PDFs).

    # --- SSL/TLS Configuration ---
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off; # Modern recommendation, lets client choose from strong ciphers offered.
    # Strong cipher suite - regularly review for current best practices (e.g., from Mozilla SSL Config Generator)
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_session_cache shared:SSL:10m; # Adjust size based on traffic
    ssl_session_timeout 1d; # Or shorter, e.g., 4h
    # ssl_session_tickets off; # Improves forward secrecy, minor performance hit. Consider if OCSP stapling is used.

    # --- Logging ---
    log_format timed_combined   '$remote_addr - $remote_user [$time_local] '
        '"$request" $status $body_bytes_sent '
        '"$http_referer" "$http_user_agent" '
        'LB_IP:$http_x_forwarded_for '
        'Backend:$upstream_addr '
        'Conn:$connection $connection_requests '
        'ReqTime:$request_time '
        'UpstreamTime:$upstream_response_time '
        'UpstreamStatus:$upstream_status '
        'UpstreamCache:$upstream_cache_status '
        'BytesSent:$bytes_sent '
        'ReqLength:$request_length '
        'Pipe:$pipe '
        'Protocol:$server_protocol '
        'Host:$host';   

    access_log /var/log/nginx/access.log timed_combined;
    error_log /var/log/nginx/error.log warn; 

    # --- MIME Types ---
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # --- Compression ---
    gzip on;
    gzip_vary on;
    gzip_proxied any; # Or more specific like 'expired no-cache no-store private auth'
    gzip_comp_level {{ nginx_gzip_comp_level | default(5) }}; # 5-6 is a good balance
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length {{ nginx_gzip_min_length | default(256) }}; # Don't gzip tiny files
    gzip_types # Ensure this list is comprehensive for your text-based assets
        text/plain
        text/css
        text/xml
        text/javascript
        application/xml
        application/xml+rss
        application/json
        image/svg+xml; 


    # --- Rate Limiting (Commented Out for Now) ---
    # Helps protect against brute force, scraping, or basic DDoS at the Nginx level.
    #
    # Limit request rate per IP (e.g., 10 requests per second)
    # limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
    #
    # Limit number of simultaneous connections per IP
    # limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    #
    # Then, in server or location blocks:
    # limit_req zone=req_limit_per_ip burst=20 nodelay;
    # limit_conn conn_limit_per_ip 10;


    # =========================================================================
    # [CRITICAL UPDATE] BUFFER SIZES FOR JWT/HTTP2
    # =========================================================================
    
    # 1. Standard Client Buffers (Used for HTTP/1.1 AND decompressed HTTP/2)
    # Increased from 4M/2k/8k to fit large Authorization headers
    client_body_buffer_size {{ nginx_client_body_buffer_size | default("512k") }};
    client_header_buffer_size {{ nginx_client_header_buffer_size | default("64k") }}; 
    client_max_body_size {{ nginx_client_max_body_size | default('100M') }}; 
    large_client_header_buffers {{ nginx_large_client_header_buffers_number | default(16) }} {{ nginx_large_client_header_buffers_size | default("64k") }}; # Crucial: Allows headers up to 64KB

    # 2. HTTP/2 Specific Buffers (New Directives)
    # Defaults are 4k/16k, which causes the drop. We increase them here.
    http2_max_field_size {{ nginx_http2_max_field_size | default("64k") }};
    http2_max_header_size {{ nginx_http2_max_header_size | default("128k") }}; 
    
    # =========================================================================

    # --- WebSocket Support (if needed by any sites) ---
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # --- Include Site Configurations ---
    # These will inherit the http block settings, can override or add more specific headers.
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}